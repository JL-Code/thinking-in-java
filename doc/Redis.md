# Redis 基础知识

## FAQ

### Q：为什么 Redis 是单线程？

A：Redis利用队列技术将并发访问变为串行访问，消除了传统数据库串行控制的开销。**多线程处理会涉及到锁，而且多线程处理会涉及到线程切换而消耗CPU**。**因为CPU不是Redis的瓶颈，Redis的瓶颈最有可能是机器内存或者网络带宽。**单线程无法发挥多核CPU性能，不过可以通过在单机开多个Redis实例来解决。

### Q：Redis有哪几种数据淘汰策略？

A：

1.volatile-lru:从已设置过期的数据集中**挑选最近最少使用的淘汰**

2.volatile-ttr:从已设置过期的数据集中**挑选将要过期的数据淘汰**

3.volatile-random:从已设置过期的数据集中**任意挑选数据淘汰**

4.allkeys-lru:从数据集中挑选最近最少使用的数据淘汰

5.allkeys-random:从数据集中任意挑选数据淘汰

6.noenviction:禁止淘汰数据

### Q: Redis提供了哪几种持久化方式？

A: **RDB** 、**AOF**

**RDB:**

**默认开启**，会按照配置的指定时间将内存中的数据快照到磁盘中，**创建一个dump.rdb文件**，Redis启动时再恢复到内存中。

**Redis会单独创建fork()一个子进程，将当前父进程的数据库数据复制到子进程的内存中，然后由子进程写入到临时文件中，持久化的过程结束了，再用这个临时文件替换上次的快照文件，然后子进程退出，内存释放。**

需要注意的是，每次快照持久化都会将主进程的数据库数据复制一遍，导致内存开销加倍，若此时内存不足，则会阻塞服务器运行，直到复制结束释放内存；都会将内存数据完整写入磁盘一次，所以如果数据量大的话，而且写操作频繁，必然会引起大量的磁盘I/O操作，严重影响性能，并且最后一次持久化后的数据可能会丢失；

**AOF:**

**以日志的形式记录每个写操作（读操作不记录），只需追加文件但不可以改写文件，Redis启动时会根据日志从头到尾全部执行一遍以完成数据的恢复工作**。包括flushDB也会执行。

**主要有两种方式触发：有写操作就写、每秒定时写（也会丢数据）。**

因为AOF采用追加的方式，所以文件会越来越大，针对这个问题，新增了重写机制，就是当日志文件大到一定程度的时候，会fork出一条新进程来遍历进程内存中的数据，每条记录对应一条set语句，写到临时文件中，然后再替换到旧的日志文件（类似rdb的操作方式）。默认触发是当aof文件大小是上次重写后大小的一倍且文件大于64M时触发。

当两种方式同时开启时，数据恢复Redis会优先选择AOF恢复。一般情况下，只要使用默认开启的RDB即可，因为相对于AOF，RDB便于进行数据库备份，并且恢复数据集的速度也要快很多。

开启持久化缓存机制，对性能会有一定的影响，特别是当设置的内存满了的时候，更是下降到几百reqs/s。所以如果只是用来做缓存的话，可以关掉持久化。

### Q: Redis 实践中有哪些性能问题？

参考：https://youzhixueyuan.com/redis-interview-question-49-answers.html

## 数据类型

1.string：最基本的数据类型，二进制安全的字符串，最大512M。

2.list：按照添加顺序保持顺序的字符串列表。

3.set：无序的字符串集合，不存在重复的元素。

4.sorted set：已排序的字符串集合。

5.hash：key-value对的一种集合。

| 类型       | 最大存储数据量 | 应用场景                             |
| ---------- | -------------- | ------------------------------------ |
| string     | 512M           | 1. 简单k-v存储                       |
| list       | 2^32-1         | 1.时间线 2.消息队列                  |
| set        | 2^32-1         | 1.统计访问网站的独立IP（set 唯一性） |
| sorted set | 2^32-1         | 1. 排行榜 2.带权重的消息队列         |
| hash       | 2^32-1         | 1.复杂对象存储                       |

<img src="/Users/codeme/IdeaProjects/thinking-in-java/doc/assets/redis-data-type-desc.png" alt="image-20200722131949019" style="zoom:50%;" />

参考：https://redis.io/topics/data-types

